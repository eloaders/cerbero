' Gambas class file

Create Static
Public WEBSITE_ROOT_URL As String = CGI["SERVER_NAME"]
Public WEBSITE_ROOT_URL_HTTP As String = "http://" & WEBSITE_ROOT_URL
Public WHEREIS_SITE_ROOT As String = CGI["DOCUMENT_ROOT"]
Public Function IsMimeType(file As String, ...) As Boolean
  
  Dim data, s As String
  Exec ["file", "-i", file] To data
  
  For Each s In Param
    If InStr(data, s) Then Return True
  Next
  
  Return False
  
End

Public Function CheckEMail(email As String) As Boolean

  Dim regex As New Regexp(email, "^[a-z0-9._-]+@[a-z0-9._-]{2,}\\.[a-z]{2,4}$")

  Return regex.Offset <> -1

End

Public Function GravatarAV(email As String, Optional Size As String) As String
  Dim AVHash As String
  Dim URL As String = "https://secure.gravatar.com/avatar/"
  Shell "echo -n " & email & " | tr '[:upper:]' '[:lower:]' | md5sum" Wait To AVHash
  AVHash = Replace(Replace(Replace(Replace(AVHash, "\t", ""), "-", ""), "\n", ""), " ", "")
  If IsNull(Size) Then
    Return URL & AVHash
  Else
    Return URL & AVHash & "?s=" & Size
  Endif
End

Public Function LatestKernel() As String
  Dim KERNEL As Collection
  KERNEL = JSON.Decode(File.Load(WHEREIS_SITE_ROOT & "/releases.json"))
  Return KERNEL["latest_stable"]["version"]
End

Public Function ShortURL(LongURL As String) As String
Dim Parms As String[] = Null
Dim OutputURL As String = Temp()
Dim hClient As HttpClient
Dim sBuffer As String

hClient = New HttpClient As "hClient"
hClient.URL = "https://www.googleapis.com/urlshortener/v1/url"
hClient.Async = False
hClient.Timeout = 60
hClient.Post("application/json", "{\"longUrl\": \"" & LongURL & "\"}", ["Content-Type: application/json"], OutputURL)

Return File.Load(OutputURL)
End

Public Function CRB_OUTPUTS(DATA As String, Optional PASTENAME As String, Optional AUTHOR As String) As String
  
Dim Parms As String[] = Null
Dim OutputURL As String = Temp()
Dim hClient As HttpClient
Dim sBuffer As String

hClient = New HttpClient As "hClient"
hClient.URL = "http://crb.i-nex.pl/api/create"
hClient.Async = False
hClient.Timeout = 60
hClient.Post("application/x-www-form-urlencoded", "text=" & DATA & "&title=" & PASTENAME & "&name=" & AUTHOR & "", ["Content-Type: application/x-www-form-urlencoded"], OutputURL)

Return Replace(File.Load(OutputURL), "\n", "")
  
End

Public Function CRB_TOTALREPORTS() As String
  Dim Total_Reports As String
  Shell "ls " & WHEREIS_SITE_ROOT & "/ValidDB/* | grep json | sort | wc -l" Wait To Total_Reports
  Total_Reports = Replace(Total_Reports, "\n", "")
  Return Total_Reports
End

Public Function CRB_TOTALUSERS() As String
  Dim Total_USERS As String
  Shell "ls " & WHEREIS_SITE_ROOT & "/Users/ | sort | wc -l" Wait To Total_USERS
  Total_USERS = Replace(Total_USERS, "\n", "")
  Return Total_USERS
End
