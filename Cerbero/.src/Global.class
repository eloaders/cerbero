' Gambas class file

Create Static
Public WEBSITE_ROOT_URL As String = CGI["SERVER_NAME"]
Public WEBSITE_ROOT_URL_HTTP As String = "http://" & WEBSITE_ROOT_URL
Public WHEREIS_SITE_ROOT As String = CGI["DOCUMENT_ROOT"]
Public Function IsMimeType(file As String, ...) As Boolean
  
  Dim data, s As String
  Exec ["file", "-i", file] To data
  
  For Each s In Param
    If InStr(data, s) Then Return True
  Next
  
  Return False
  
End

Public Function CheckEMail(email As String) As Boolean

  Dim regex As New Regexp(email, "^[a-z0-9._-]+@[a-z0-9._-]{2,}\\.[a-z]{2,4}$")

  Return regex.Offset <> -1

End

Public Function GravatarAV(email As String, Optional Size As String) As String
  Dim AVHash As String
  Dim URL As String = "https://secure.gravatar.com/avatar/"
  Shell "echo -n " & email & " | tr '[:upper:]' '[:lower:]' | md5sum" Wait To AVHash
  AVHash = Replace(Replace(Replace(Replace(AVHash, "\t", ""), "-", ""), "\n", ""), " ", "")
  If IsNull(Size) Then
    Return URL & AVHash
  Else
    Return URL & AVHash & "?s=" & Size
  Endif
End

Public Function LatestKernel() As String
  Dim KERNEL As Collection
  KERNEL = JSON.Decode(File.Load(WHEREIS_SITE_ROOT & "/releases.json"))
  Return KERNEL["latest_stable"]["version"]
End

Public Function ShortURL(LongURL As String) As String
Dim OutputURL As String = Temp()
Dim hClient As HttpClient

hClient = New HttpClient As "hClient"
hClient.URL = "https://www.googleapis.com/urlshortener/v1/url"
hClient.Async = False
hClient.Timeout = 60
hClient.Post("application/json", "{\"longUrl\": \"" & LongURL & "\"}", ["Content-Type: application/json"], OutputURL)

Return File.Load(OutputURL)
End

Public Function CRB_OUTPUTS(DATA As String, Optional PASTENAME As String, Optional AUTHOR As String) As String

Dim OutputURL As String = Temp()
Dim hClient As HttpClient

hClient = New HttpClient As "hClient"
hClient.URL = "http://crb.i-nex.pl/api/create"
hClient.Async = False
hClient.Timeout = 60
hClient.Post("application/x-www-form-urlencoded", "text=" & DATA & "&title=" & PASTENAME & "&name=" & AUTHOR & "", ["Content-Type: application/x-www-form-urlencoded"], OutputURL)

Return Replace(File.Load(OutputURL), "\n", "")
  
End

Public Function CRB_TOTALREPORTS() As String
  Dim Total_Reports As String
  Shell "ls " & WHEREIS_SITE_ROOT & "/ValidDB/* | grep json | sort | wc -l" Wait To Total_Reports
  Total_Reports = Replace(Total_Reports, "\n", "")
  Return Total_Reports
End

Public Function CRB_TOTALUSERS() As String
  Dim Total_USERS As String
  Shell "ls " & WHEREIS_SITE_ROOT & "/Users/ | sort | wc -l" Wait To Total_USERS
  Total_USERS = Replace(Total_USERS, "\n", "")
  Return Total_USERS
End

Public Function CRB_TODAYREPORTS() As String
  Dim Today_Reports As String
  Dim DDATE_NOW As String
  DDATE_NOW = Date(Now)
  DDATE_NOW = Replace(DDATE_NOW, "/", "")
  Shell "ls " & WHEREIS_SITE_ROOT & "/ValidDB/" & DDATE_NOW & "* | sort | wc -l" Wait To Today_Reports
  Today_Reports = Replace(Today_Reports, "\n", "")
  Return Today_Reports
End

Public Function REPORTSINDB(cpuname As String) As String
  Dim CPUCOUNT As String
  If cpuname Like "*Atom*" Then
    cpuname = Replace(cpuname, "Atom", "")
  Endif
  If cpuname Like "*Core*" Then
    cpuname = Replace(cpuname, "Core", "")
  Endif
  
  Shell "cd " & CGI["DOCUMENT_ROOT"] & "/ValidDB && grep -e \"CPU_NAME\" ./*/* | grep -i \"" & cpuname & "\" | awk {'print $1'} | wc -l" Wait To CPUCOUNT
  
  Return CPUCOUNT
End

Public Function REPLACE_CPUNAME(cpuname As String) As String
  Select Case cpuname
    Case Like "*Atom*"
      cpuname = Replace(cpuname, "Atom", "")
    Case Like "*Core*"
      cpuname = Replace(cpuname, "Core", "")
  End Select
  Return cpuname
End

Public Function GEN_USERBAR(CPU As String, OpenGL As String, MOBO As String, DIST As String, KERNEL As String, Outputs As String)
  Shell "/usr/bin/crbusrb.py --input=\"" & WHEREIS_SITE_ROOT & "/USERBAR/sample_in.png\" --cpu=\"" & CPU & "\" --opengl=\"" & OpenGL & "\" --mobo=\"" & MOBO & "\" --dist=\"" & DIST & "\" --kernel=\"" & KERNEL & "\" --output=\"" & Outputs & "\"" Wait
  'crbusrb.py --input="sample_in.png" 
  '--cpu="A10-4600M APU with Radeon(tm) HD Graphics 1400 MHz X4" 
  '--opengl="Gallium 0.4 on AMD ARUBA DRV: radeon" 
  '--mobo="LENOVO ThinkPad Edge E535" 
  '--dist="Ubuntu 14.04 Unity 7.1.2" 
  '--kernel="3.14.5-ext73-f1-29.5-atom-ags-cfs" 
  '--output="/home/michal/Pulpit/simple.png"
End
